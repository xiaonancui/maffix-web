generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                   @id @default(uuid())
  email               String                   @unique
  name                String
  password            String?
  role                Role                     @default(USER)
  avatar              String?
  diamondBalance      Int                      @default(0)
  points              Int                      @default(0)
  level               Int                      @default(1)
  gachaPityCounter    Int                      @default(0)
  hasCompletedTenDraw Boolean                  @default(false)
  provider            String?
  providerId          String?
  tiktokUsername      String?
  tiktokUserId        String?
  tiktokAccessToken   String?
  tiktokRefreshToken  String?
  tiktokTokenExpiry   DateTime?
  tiktokLinkedAt      DateTime?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  lastLoginAt         DateTime?
  themePreference     String?                  @default("system")
  accounts            Account[]
  cart                Cart?
  drawTickets         DrawTicket[]
  gachaPulls          GachaPull[]
  verificationJobs    MissionVerificationJob[]
  orders              Order[]
  purchases           Purchase[]
  sessions            Session[]
  transactions        Transaction[]
  prizes              UserPrize[]
  completedTasks      UserTask[]

  @@index([email])
  @@index([provider, providerId])
  @@index([tiktokUsername])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Task {
  id                  String                   @id @default(uuid())
  title               String
  description         String
  type                TaskType
  difficulty          Difficulty               @default(EASY)
  missionType         MissionType?
  targetTikTokAccount String?
  targetVideoUrl      String?
  targetAudioId       String?
  autoVerify          Boolean                  @default(false)
  verificationStatus  String?
  points              Int                      @default(0)
  diamonds            Int                      @default(0)
  isActive            Boolean                  @default(true)
  startDate           DateTime?
  endDate             DateTime?
  maxCompletions      Int?
  completionCount     Int                      @default(0)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  verificationJobs    MissionVerificationJob[]
  completions         UserTask[]

  @@index([type])
  @@index([isActive])
  @@index([missionType])
  @@map("tasks")
}

model UserTask {
  id                 String                  @id @default(uuid())
  userId             String
  taskId             String
  submittedAt        DateTime                @default(now())
  completedAt        DateTime?
  pointsEarned       Int
  diamondsEarned     Int
  verified           Boolean                 @default(false)
  verifiedAt         DateTime?
  verifiedBy         String?
  verificationStatus VerificationStatus      @default(PENDING)
  verificationJob    MissionVerificationJob?
  task               Task                    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId])
  @@index([userId])
  @@index([taskId])
  @@index([verificationStatus])
  @@map("user_tasks")
}

model Prize {
  id           String        @id @default(uuid())
  name         String
  description  String
  rarity       Rarity
  image        String?
  value        Int           @default(0)
  type         PrizeType
  isActive     Boolean       @default(true)
  stock        Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  gachaItems   GachaItem[]
  gachaPulls   GachaPull[]
  premiumPacks PremiumPack[]
  userPrizes   UserPrize[]

  @@index([rarity])
  @@index([isActive])
  @@map("prizes")
}

model UserPrize {
  id         String      @id @default(uuid())
  userId     String
  prizeId    String
  acquiredAt DateTime    @default(now())
  source     PrizeSource
  redeemed   Boolean     @default(false)
  redeemedAt DateTime?
  prize      Prize       @relation(fields: [prizeId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([prizeId])
  @@map("user_prizes")
}

model GachaItem {
  id          String      @id @default(uuid())
  prizeId     String
  probability Float
  pityCounter Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  prize       Prize       @relation(fields: [prizeId], references: [id], onDelete: Cascade)
  pulls       GachaPull[]

  @@index([isActive])
  @@map("gacha_items")
}

model GachaPull {
  id            String    @id @default(uuid())
  userId        String
  gachaItemId   String
  prizeId       String?
  pulledAt      DateTime  @default(now())
  cost          Int
  pullType      PullType  @default(SINGLE)
  batchId       String?
  pullIndex     Int?
  wasGuaranteed Boolean   @default(false)
  won           Boolean   @default(false)
  gachaItem     GachaItem @relation(fields: [gachaItemId], references: [id], onDelete: Cascade)
  prize         Prize?    @relation(fields: [prizeId], references: [id])
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gachaItemId])
  @@index([batchId])
  @@map("gacha_pulls")
}

model DrawTicket {
  id         String     @id @default(uuid())
  userId     String
  ticketType TicketType @default(SINGLE)
  quantity   Int        @default(1)
  source     String
  sourceRef  String?
  expiresAt  DateTime?
  used       Boolean    @default(false)
  usedAt     DateTime?
  createdAt  DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([used])
  @@index([expiresAt])
  @@map("draw_tickets")
}

model Transaction {
  id          String            @id @default(uuid())
  userId      String
  type        TransactionType
  amount      Int
  currency    Currency
  description String
  reference   String?
  status      TransactionStatus @default(COMPLETED)
  createdAt   DateTime          @default(now())
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

model PremiumPack {
  id                String     @id @default(uuid())
  name              String
  description       String
  price             Float
  currency          String     @default("USD")
  guaranteedPrizeId String?
  bonusTickets      Int        @default(0)
  bonusDiamonds     Int        @default(0)
  imageUrl          String?
  featured          Boolean    @default(false)
  sortOrder         Int        @default(0)
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  guaranteedPrize   Prize?     @relation(fields: [guaranteedPrizeId], references: [id])
  purchases         Purchase[]

  @@index([isActive])
  @@index([featured])
  @@map("premium_packs")
}

model Purchase {
  id              String         @id @default(uuid())
  userId          String
  packId          String
  klarnaOrderId   String?        @unique
  stripeSessionId String?        @unique
  paymentMethod   PaymentMethod  @default(KLARNA)
  amount          Float
  currency        String         @default("USD")
  status          PurchaseStatus @default(PENDING)
  itemsGranted    Boolean        @default(false)
  ticketsGranted  Boolean        @default(false)
  diamondsGranted Boolean        @default(false)
  createdAt       DateTime       @default(now())
  completedAt     DateTime?
  pack            PremiumPack    @relation(fields: [packId], references: [id])
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([packId])
  @@index([status])
  @@index([klarnaOrderId])
  @@index([stripeSessionId])
  @@map("purchases")
}

model MissionVerificationJob {
  id                 String      @id @default(uuid())
  userId             String
  taskId             String
  userTaskId         String      @unique
  missionType        MissionType
  status             JobStatus   @default(PENDING)
  tiktokUsername     String?
  targetData         String?
  verificationResult Boolean?
  errorMessage       String?
  attempts           Int         @default(0)
  maxAttempts        Int         @default(3)
  nextRetryAt        DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  completedAt        DateTime?
  task               Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userTask           UserTask    @relation(fields: [userTaskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("mission_verification_jobs")
}

model Merchandise {
  id          String               @id @default(uuid())
  name        String
  description String
  price       Float
  category    MerchandiseCategory
  material    String?
  features    String[]
  tags        String[]
  inStock     Boolean              @default(true)
  featured    Boolean              @default(false)
  sortOrder   Int                  @default(0)
  imageUrl    String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  cartItems   CartItem[]
  images      MerchandiseImage[]
  variants    MerchandiseVariant[]
  orderItems  OrderItem[]

  @@index([category])
  @@index([featured])
  @@index([inStock])
  @@map("merchandise")
}

model MerchandiseVariant {
  id            String      @id @default(uuid())
  merchandiseId String
  size          String?
  color         String?
  sku           String      @unique
  priceModifier Float       @default(0)
  stockQuantity Int         @default(0)
  inStock       Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  cartItems     CartItem[]
  merchandise   Merchandise @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]

  @@index([merchandiseId])
  @@index([sku])
  @@map("merchandise_variants")
}

model MerchandiseImage {
  id            String      @id @default(uuid())
  merchandiseId String
  url           String
  altText       String?
  sortOrder     Int         @default(0)
  isPrimary     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  merchandise   Merchandise @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)

  @@index([merchandiseId])
  @@map("merchandise_images")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id            String              @id @default(uuid())
  cartId        String
  merchandiseId String
  variantId     String?
  quantity      Int                 @default(1)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  cart          Cart                @relation(fields: [cartId], references: [id], onDelete: Cascade)
  merchandise   Merchandise         @relation(fields: [merchandiseId], references: [id], onDelete: Cascade)
  variant       MerchandiseVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, merchandiseId, variantId])
  @@index([cartId])
  @@index([merchandiseId])
  @@map("cart_items")
}

model Order {
  id                    String         @id @default(uuid())
  userId                String
  orderNumber           String         @unique
  status                OrderStatus    @default(PENDING)
  totalAmount           Float
  currency              String         @default("USD")
  shippingName          String
  shippingEmail         String
  shippingAddress       String
  shippingCity          String
  shippingState         String?
  shippingZip           String
  shippingCountry       String
  shippingPhone         String?
  paymentMethod         PaymentMethod?
  paymentId             String?
  stripeSessionId       String?
  stripePaymentIntentId String?
  paidAt                DateTime?
  trackingNumber        String?
  shippedAt             DateTime?
  deliveredAt           DateTime?
  customerNotes         String?
  adminNotes            String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  items                 OrderItem[]
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id            String              @id @default(uuid())
  orderId       String
  merchandiseId String
  variantId     String?
  name          String
  description   String?
  price         Float
  quantity      Int
  size          String?
  color         String?
  imageUrl      String?
  createdAt     DateTime            @default(now())
  merchandise   Merchandise         @relation(fields: [merchandiseId], references: [id])
  order         Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant       MerchandiseVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([merchandiseId])
  @@map("order_items")
}

model Release {
  id            String   @id @default(uuid())
  title         String
  artist        String
  description   String?
  videoUrl      String
  videoId       String?
  thumbnailUrl  String?
  duration      String?
  views         String?
  releaseDate   DateTime
  genre         String?
  tags          String[]
  spotifyUrl    String?
  appleMusicUrl String?
  tidalUrl      String?
  soundcloudUrl String?
  featured      Boolean  @default(false)
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([artist])
  @@index([releaseDate])
  @@index([featured])
  @@index([isActive])
  @@map("releases")
}

enum Role {
  USER
  ADMIN
  ARTIST
}

enum TaskType {
  SOCIAL
  CONTENT
  DAILY
  PROFILE
  REFERRAL
  PURCHASE
  EVENT
}

enum MissionType {
  FOLLOW
  LIKE
  REPOST
  USE_AUDIO
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum VerificationStatus {
  PENDING
  APPROVED
  FAILED
}

enum Rarity {
  COMMON
  RARE
  EPIC
  SSR
  LEGENDARY
}

enum PrizeType {
  PHYSICAL
  DIGITAL
  EXPERIENCE
  DISCOUNT
  EXCLUSIVE
}

enum PrizeSource {
  GACHA
  PURCHASE
  REWARD
  GIFT
}

enum PullType {
  SINGLE
  MULTI_10X
}

enum TicketType {
  SINGLE
  MULTI_10X
}

enum TransactionType {
  EARN
  SPEND
  PURCHASE
  GIFT
  REFUND
  ADJUSTMENT
}

enum Currency {
  DIAMONDS
  POINTS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  KLARNA
  STRIPE
  PAYPAL
}

enum PurchaseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum MerchandiseCategory {
  CLOTHING
  ACCESSORIES
  MUSIC
  COLLECTIBLES
  OTHER
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}
