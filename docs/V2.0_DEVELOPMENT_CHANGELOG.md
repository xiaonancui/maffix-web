# Maffix Web v2.0 Development Changelog

**Commit:** `03b95a5`
**Date:** 2025-12-25
**Version:** 2.0.0

---

## Table of Contents

1. [Overview](#overview)
2. [Database Schema Changes](#database-schema-changes)
3. [New Features](#new-features)
4. [API Endpoints](#api-endpoints)
5. [UI Components](#ui-components)
6. [Library Changes](#library-changes)
7. [Breaking Changes](#breaking-changes)
8. [Migration Guide](#migration-guide)
9. [Known Issues & TODOs](#known-issues--todos)

---

## Overview

This document details all changes made in the Maffix v2.0 development plan. The update focuses on:

- **Level System**: 50-level progression with XP rewards
- **Aura Zone**: Renamed gacha system with new probabilities and 10x-only draws
- **Mission Verification**: Manual screenshot-based verification system
- **Homepage OTP Gate**: Email verification before accessing homepage
- **Ticket Currency**: New currency earned from store purchases

---

## Database Schema Changes

### Prisma Schema Updates (`apps/web/prisma/schema.prisma`)

#### User Model - New Fields

```prisma
model User {
  // ... existing fields ...

  // NEW: Level system fields
  xp              Int      @default(0)
  ticketBalance   Int      @default(0)

  // NEW: Homepage OTP verification
  otpSecret       String?  @unique
  isHomepageVerified Boolean @default(false)
}
```

**Details:**
- `xp`: User experience points, determines level progression
- `ticketBalance`: Number of tickets available for Aura Zone draws
- `otpSecret`: Secret key for OTP generation (email verification)
- `isHomepageVerified`: Whether user has passed homepage OTP gate

#### Task Model - New Fields

```prisma
model Task {
  // ... existing fields ...

  // NEW: Level system rewards
  xpReward        Int?     @default(0)

  // NEW: Verification type
  verificationType VerificationType @default(AUTO)
}
```

**Details:**
- `xpReward`: XP granted upon task completion
- `verificationType`: AUTO (instant) or MANUAL (screenshot review required)

#### UserTask Model - New Fields

```prisma
model UserTask {
  // ... existing fields ...

  // NEW: Screenshot verification
  screenshotUrl   String?

  // NEW: Level system tracking
  xpEarned        Int      @default(0)
}
```

**Details:**
- `screenshotUrl`: S3/cloud URL for task completion screenshot
- `xpEarned`: XP actually earned (may differ from task.xpReward due to bonuses)

#### Order Model - New Field

```prisma
model Order {
  // ... existing fields ...

  // NEW: Ticket rewards from purchases
  ticketsEarned   Int?     @default(0)
}
```

**Details:**
- `ticketsEarned`: Tickets granted from store purchase (calculated as `floor(subtotalGBP / 10)`)

#### Merchandise Model - New Fields

```prisma
model Merchandise {
  // ... existing fields ...

  // NEW: Bundle support
  productCode     String?  @unique
  isBundleOnly    Boolean  @default(false)
  bundleType      String?
}
```

**Details:**
- `productCode`: Unique product identifier for external systems
- `isBundleOnly`: Can only be purchased as part of a bundle
- `bundleType`: Bundle category (e.g., "starter-pack", "seasonal")

#### PremiumPack Model - New Field

```prisma
model PremiumPack {
  // ... existing fields ...

  // NEW: Visibility control
  isHidden        Boolean  @default(true)
}
```

**Details:**
- `isHidden`: Hide from storefront (default true for new packs)

#### New Enums

```prisma
// Updated Rarity enum - removed EPIC, added SR and UR
enum Rarity {
  COMMON      // Common items
  RARE        // Rare items
  SR          // Super Rare (NEW)
  SSR         // Super Super Rare items
  UR          // Ultra Rare (NEW - highest for Aura Zone)
  LEGENDARY   // Legendary items (legacy)
}

// Updated Currency enum - added TICKETS
enum Currency {
  DIAMONDS
  POINTS
  TICKETS     // NEW: Gacha tickets from store purchases
}

// NEW: Verification type for tasks
enum VerificationType {
  AUTO        // Automatic verification
  MANUAL      // Manual screenshot verification required
}
```

---

## New Features

### 1. Level System

**File:** `apps/web/src/lib/level-system.ts`

**XP Thresholds Formula:**
```typescript
xpThreshold = base * (1.5 ^ (level - 1))
where base = 100 for level 1
```

**Level Rewards:**
- Regular levels (1-50): 30 diamonds each
- Milestone levels (5, 10, 15, 20, 25, 30, 35, 40, 45, 50): 80 diamonds each

**Key Functions:**

| Function | Description |
|----------|-------------|
| `calculateLevelUp(currentXp, currentLevel, xpToAdd)` | Calculate level gains from XP |
| `getLevelProgress(currentXp, currentLevel)` | Get progress percentage to next level |
| `getNextLevelThreshold(currentLevel)` | Get XP needed for next level |
| `getTotalDiamondReward(levelsGained)` | Calculate total diamond rewards |

**Example Usage:**
```typescript
import { calculateLevelUp } from '@/lib/level-system'

const result = calculateLevelUp(
  250,  // current XP
  2,    // current level
  150   // XP to add
)
// Returns: { newLevel: 3, levelsGained: 1, totalDiamondReward: 30, remainingXp: 50 }
```

---

### 2. Aura Zone (Renamed from Gacha)

**Files:**
- `apps/web/src/lib/aura-zone.ts`
- `apps/web/src/app/(dashboard)/aura-zone/page.tsx`
- `apps/web/src/app/(dashboard)/aura-zone/aura-zone-client.tsx`
- `apps/web/src/app/api/aura-zone/pull/route.ts`

**New Probability Distribution:**

| Rarity | Probability | Color |
|--------|-------------|-------|
| UR (Ultra Rare) | 3.0% | Red gradient |
| SSR (Super Super Rare) | 15.65% | Gold gradient |
| SR (Super Rare) | 25.0% | Purple gradient |
| R (Rare) | 35.0% | Blue gradient |
| N (Normal) | 21.35% | Gray gradient |

**Cost:**
- 10x Draw with Diamonds: 3000
- 10x Draw with Tickets: 10

**Changes from Old Gacha:**
- Removed single-pull option (10x only)
- Removed SSR guarantee/pity system
- No "spook" protection
- Pure random selection

**Banner Types:**
```typescript
type BannerType = 'beat-like-dat' | 'sybau'
```

---

### 3. Homepage OTP Gate

**Files:**
- `apps/web/src/components/marketing/HomepageGate.tsx`
- `apps/web/src/app/api/homepage-otp/send/route.ts`
- `apps/web/src/app/api/homepage-otp/verify/route.ts`

**Flow:**
1. User enters email address
2. System generates 6-digit OTP code
3. Code sent to email (dev mode: logged to console)
4. User enters code to verify
5. On success, `isHomepageVerified` set to `true`

**Security Notes:**
- OTP expires after 5 minutes
- Uses `otpSecret` field for code generation
- Rate limiting should be added (TODO)

---

### 4. Mission Screenshot Verification

**Files:**
- `apps/web/src/components/dashboard/missions/MissionDetailModal.tsx`
- `apps/web/src/app/api/missions/submit/route.ts`
- `apps/web/src/app/api/missions/upload-screenshot/route.ts`
- `apps/web/src/app/(admin)/admin/missions/verification/page.tsx`
- `apps/web/src/app/api/admin/missions/verify/route.ts`

**User Flow:**
1. User clicks "Submit" on mission with MANUAL verification
2. Modal opens with mission details and upload field
3. User uploads screenshot (max 5MB, images only)
4. On submit:
   - Screenshot uploaded to `public/uploads/screenshots/`
   - UserTask created with `verificationStatus: PENDING`
5. Admin reviews in `/admin/missions/verification`
6. Admin approves/rejects with optional reason

**Admin Review Page Features:**
- View all pending submissions
- Preview screenshot
- See user info and mission details
- Individual approve/reject
- Batch approve all

---

### 5. Mission Categories Simplified

**Change:** Missions now categorized as:
- **Follow Missions**: Easy social media follows
- **Main Missions**: All other mission types

**Removed:** Individual category filters for LIKE, REPOST, USE_AUDIO

---

## API Endpoints

### New Endpoints

#### POST `/api/homepage-otp/send`
Send OTP code to user's email.

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "OTP sent to email"
}
```

#### POST `/api/homepage-otp/verify`
Verify OTP code and mark homepage as verified.

**Request:**
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Homepage verified successfully"
}
```

#### POST `/api/missions/submit`
Submit mission completion with screenshot.

**Request:**
```json
{
  "missionId": "mission_123",
  "screenshotUrl": "/uploads/screenshots/user123_task456.png"
}
```

**Response:**
```json
{
  "success": true,
  "userTaskId": "usertask_789",
  "message": "Mission submitted for verification"
}
```

#### POST `/api/missions/upload-screenshot`
Upload screenshot image.

**Request:** `multipart/form-data`
- `file`: Image file (max 5MB)

**Response:**
```json
{
  "success": true,
  "url": "/uploads/screenshots/user123_task456_1735123456789.png"
}
```

#### POST `/api/admin/missions/verify`
Admin approve or reject mission submission.

**Request:**
```json
{
  "userTaskId": "usertask_789",
  "action": "approve",  // or "reject"
  "reason": "Optional rejection reason"
}
```

**Response (Approve):**
```json
{
  "success": true,
  "message": "Task approved and rewards granted",
  "levelUp": {
    "newLevel": 5,
    "bonusDiamonds": 80
  }
}
```

#### POST `/api/aura-zone/pull`
Perform 10x gacha pull.

**Request:**
```json
{
  "paymentMethod": "diamonds",  // or "tickets"
  "bannerId": "beat-like-dat"
}
```

**Response:**
```json
{
  "success": true,
  "pulls": [
    {
      "prizeId": "prize_123",
      "prizeName": "Exclusive Item",
      "rarity": "UR",
      "rarityDisplay": "UR",
      "rarityColor": "bg-gradient-to-r from-red-600 to-orange-500",
      "rarityBorder": "border-red-500"
    }
    // ... 9 more items
  ],
  "batchId": "batch-1735123456789-abc123",
  "cost": 3000,
  "costType": "diamonds",
  "newBalance": {
    "diamonds": 7000,
    "tickets": 10
  }
}
```

---

## UI Components

### New Components

#### `components/ui/progress.tsx`
Radix UI progress bar component.

**Usage:**
```tsx
import { Progress } from '@/components/ui/progress'

<Progress value={60} className="h-2" />
```

#### `components/ui/tabs.tsx`
Radix UI tabs component.

**Usage:**
```tsx
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'

<Tabs defaultValue="tab1">
  <TabsList>
    <TabsTrigger value="tab1">Tab 1</TabsTrigger>
    <TabsTrigger value="tab2">Tab 2</TabsTrigger>
  </TabsList>
  <TabsContent value="tab1">Content 1</TabsContent>
  <TabsContent value="tab2">Content 2</TabsContent>
</Tabs>
```

#### `components/ui/alert-dialog.tsx`
Radix UI alert dialog for confirmations.

**Usage:**
```tsx
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'

<AlertDialog open={open} onOpenChange={setOpen}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Are you sure?</AlertDialogTitle>
      <AlertDialogDescription>
        This action cannot be undone.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction>Confirm</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

#### `components/dashboard/missions/MissionDetailModal.tsx`
Modal for mission details and screenshot submission.

**Props:**
```tsx
interface MissionDetailModalProps {
  mission: MissionData
  isOpen: boolean
  onClose: () => void
  userId: string
  hasTikTokLinked: boolean
}
```

#### `components/marketing/HomepageGate.tsx`
Homepage OTP verification gate.

**Props:**
```tsx
interface HomepageGateProps {
  isVerified: boolean
  userId?: string
}
```

---

## Library Changes

### Updated Libraries

#### `src/lib/gacha.ts`
**Changes:**
- Updated `RARITY_PROBABILITIES` to use new Rarity enum (SR, UR)
- Updated `isSSROrHigher()` to include UR
- Updated display names and colors for all rarities
- Fixed rarity value mapping

#### `src/lib/rbac.ts`
**Changes:**
- Added `hasAdminAccess(role: Role): boolean` helper function

**Before:**
```typescript
// No direct admin check helper
```

**After:**
```typescript
export function hasAdminAccess(role: Role): boolean {
  return role === 'ADMIN'
}
```

---

## Breaking Changes

### 1. Rarity Enum Changes

**Before:**
```typescript
enum Rarity {
  COMMON, RARE, EPIC, SSR, LEGENDARY
}
```

**After:**
```typescript
enum Rarity {
  COMMON, RARE, SR, SSR, UR, LEGENDARY
}
```

**Impact:** Any code referencing `EPIC` will break. Replace with:
- `SR` for middle-tier items
- `SSR` for high-tier items
- `UR` for ultra-rare items

### 2. Gacha Route Renamed

**Before:** `/gacha`
**After:** `/aura-zone`

**Impact:** Update all navigation links, redirects, and external references.

### 3. Navigation Structure Changed

**Before:**
- Store was behind a level/permission gate

**After:**
- Store is always accessible
- Gacha renamed to Aura Zone
- Added ticket balance display

---

## Migration Guide

### Database Migration

After pulling these changes, run:

```bash
# Generate Prisma client
npx prisma generate

# Push schema changes to database
npx prisma db push

# Or create a migration for production
npx prisma migrate dev --name v2.0-level-system-and-aura-zone
```

### Seed Data Update

Run updated seed to get new rarity values:

```bash
npm run seed
```

### Environment Variables

No new environment variables required for this release.

### Frontend Updates Required

If you have custom components referencing:

1. **Rarity enum** - Update to use `SR`, `UR` instead of `EPIC`
2. **Gacha links** - Change `/gacha` to `/aura-zone`
3. **Mission submissions** - Update to use new modal pattern

---

## Known Issues & TODOs

### TODOs

| Area | Task | Priority |
|------|------|----------|
| Homepage OTP | Add rate limiting to `/api/homepage-otp/send` | High |
| Screenshot Upload | Move to S3/Cloudinary instead of public folder | High |
| Aura Zone | Add animation effects for pulls | Medium |
| Missions | Add reject reason notification to user | Medium |
| Level System | Add level-up celebration animation | Low |
| Admin | Add bulk actions for verification | Low |

### Known Issues

1. **Screenshot storage**: Currently storing in `public/uploads/`. This should be moved to cloud storage for production.
2. **No email provider configured**: Homepage OTP uses console log in dev mode. Configure email provider for production.
3. **No rate limiting**: OTP endpoint can be spammed. Add rate limiting.

---

## Rollback Procedure

If critical issues are found, rollback to pre-v2.0 state:

```bash
# Reset to checkpoint tag (if created)
git reset --hard pre-optimization-checkpoint

# Or reset to specific commit
git reset --hard <commit-before-v2.0>

# Revert database
npx prisma migrate resolve --rolled-back [migration-name]
```

Then redeploy the previous version.

---

## Testing Checklist

- [ ] Level up from XP gain works correctly
- [ ] Diamond rewards granted on level up
- [ ] Aura Zone 10x draw with diamonds
- [ ] Aura Zone 10x draw with tickets
- [ ] Homepage OTP email sent
- [ ] Homepage OTP verification works
- [ ] Mission screenshot upload
- [ ] Mission submission creates PENDING UserTask
- [ ] Admin can approve/reject submissions
- [ ] Approved missions grant XP and level up
- [ ] Navigation shows correct ticket balance
- [ ] Profile page displays XP progress bar

---

## Contact & Support

For questions or issues related to v2.0 changes, contact the development team or create an issue in the repository.

**Commit Reference:** `03b95a5`
**Branch:** `main`
